![TBZ Logo](../x_gitres/tbz_logo.png)


[TOC]

# KN04: Cloud-init und AWS

Beachten Sie die [allgemeinen Informationen zu den Abgaben](https://gitlab.com/ch-tbz-it/Stud/m346/m346/-/blob/main/Abgaben.md).

In dieser Kompetenz werden wir mit der Automatisierung der Installation arbeiten. 

> **Achtung:** Sie werden nun **zwei neue** Instanzen erstellen und die Datenbank vom Webserver trennen.



## Lernziele

- Wie lernen wie Sie die Installation von Servern automatisieren können und lernen dabei auch wie sie zur Fehlersuche vorgehen.
- Sie lernen die YAML Syntax
- Sie lernen Cloud-Init als Automatisierungstool kennen.
- Sie trennen die Services aus der früheren Installation und lassen die Services miteinander kommunizieren.

> **Achtung:** Sie werden Cloud-Init noch in weiteren Modulen verwenden. 



## A) Cloud-init Datei Verstehen (10%)

Sie werden nun zuerst Cloud-init Dateien und das entsprechende Format YAML verstehen lernen. **Lesen Sie sich in der [Theorie](https://gitlab.com/ch-tbz-it/Stud/m346/m346/-/blob/main/InfrastructureAsCode.md) ein zu den Themen *Cloud-init* und *YAML* .** Laden Sie nun diese [cloud-init Datei](../KN04/cloud-init.yaml) herunter. Erklären Sie alle Zeilen der Cloud-init Datei in folgendem Schema.  

```yaml
#cloud-config
users: # ....
 - name: ubuntu # Benutzername
   sudo: ALL=(ALL) NOPASSWD:ALL # sudo-Regeln für diesen Benutzer
   #...
   #...
```

**Abgaben**:

- Die dokumentierte YAML-**Datei** in Git (nicht als Screenshot)



## B) SSH-Key und Cloud-init (15%)

**Wichtig**: [Lesen Sie sich in die funktionsweise von SSH und Private/Public Key ein](https://gitlab.com/ch-tbz-it/Stud/m346/m346/-/blob/main/SshPublicPrivateKey.md).

Anstatt, dass Sie den SSH-Key im GUI auswählen, können Sie ihn auch im Cloud-Init mitgeben. Dies werden wir folgend tun.  Extrahieren Sie die beiden public-Keys aus Ihren privaten Schlüsseln, welche Sie in KN02 erstellt haben.

Erstellen Sie eine neue Instanz in AWS mit den folgenden Einstellungen:

- Ubuntu 24.04 

- Bei "Key pair" verwenden Sie ihren **zweiten** Schlüssel. 

- Keine Änderungen bei den restlichen Einstellungen, ausser..

- ... verwenden Sie die [cloud-init Datei](../KN04/cloud-init.yaml) und ersetzen Sie den Schlüssel mit ihrem **ersten öffentlichen** Schlüssel. Beachten Sie das Format 
  `ssh-rsa <ihr-Schlüssel-ohne-zeilenumbrüche> aws-key` 

- Sie können ihre Cloud-init Konfiguration einfach in dem Feld "*user data*" in der Sektion "*Advanced details*" reinkopieren


Sie verwenden nun also beide Schlüssel (einmal via cloud-init, einmal via Eigenschaften im GUI). 

Zeigen Sie nun, dass Sie **nur** mit dem **ersten privaten Key** aus der Cloud-Init Datei einloggen können.

Rufen Sie nun das cloud-init-log (`/var/log/cloud-init-output.log`) auf und merken Sie sich diesen Pfad für zukünftige Aufträge für die Fehlerfindung. 

 **Abgaben**:

- Ihre angepasste Cloud-init Konfiguration als **Datei** im Git-Repository.
- Ein Screenshot der Details der Instanz. Scrollen Sie so weit runter, dass das Feld "**Key pair assigned at launch**", sichtbar ist.
- Screenshot mit dem ssh-Befehl und des Resultats unter Verwendung des **ersten** Schlüssels.
- Screenshot mit dem ssh-Befehl und des Resultats unter Verwendung des **zweiten** Schlüssels.
- Screenshot mit dem **Auszug** aus dem Cloud-Init-Log. Der **Befehl** den Sie aufgerufen haben um das Log darzustellen und der obere Teil des Logs sollten sichtbar sein. Sie müssen nicht das gesamte Log abgeben.



## C) Template (5%)

Erstellen Sie sich ein Cloud-Init Template aufgrund der Datei aus B), welches Sie bei den folgenden Kompetenzen einsetzen.

Fügen Sie auch direkt den [öffentlichen Schlüssel für Lehrpersonen](https://gitlab.com/ch-tbz-it/Stud/m346/m346/-/blob/main/PublicKey/346.pub) hinzu **(aber nur von Ihrer Lehrperson)**, aber verwenden Sie nur den Schlüssel Ihrer Lehrperson, so dass die Lehrperson Zugriff auf alle Ihre zukünftigen Instanzen kriegt. Sie haben nun also **zwei** öffentliche Schlüssel drin - Ihren und den der Lehrperson.

**Dieses Template werden Sie in Zukunft verwenden, wenn Sie neue Cloud-Init Dateien erstellen.**



## D) Installation automatisieren (70%)

Wie eingangs bereits erwähnt, teilen Sie nun die Installation auf zwei Instanzen auf.  Sie werden nun zwei Cloud-Init Konfigurationen (***cloud-init-web.yaml, und cloud-init-db.yaml***) schreiben, die beide Installation automatisieren mit ein paar Anpassungen.

Stellen Sie sicher, dass sie die richtigen IP-Adressen verwenden. Sie können die IP-Adressen der Instanzen in AWS unter "Instances" ablesen. Schauen Sie sich diese [Illustration](https://gitlab.com/ch-tbz-it/Stud/m346/m346/-/blob/main/CloudComputing.md?ref_type=heads#netzwerk-und-sicherheit) an, um zu verstehen, wie die Instanzen miteinander kommunizieren.

**Beginnen Sie mit der Datenbank-Instanz!** Diese wird die Datenbank hosten und die Webserver-Instanz wird darauf zugreifen.

**1. Datenbank**

- Führen Sie nicht einfach die Anweisungen als Befehle aus, sondern verwenden Sie die richtigen Konfigurationsblöcke. In Teil A) haben Sie einige davon ja bereits beschrieben.
- In KN03 hatten Sie nach der Installation verschiedene Befehle ausführen müssen. Verwenden Sie die **runcmd**-Anweisung von Cloud-init, um Befehle auszuführen. Sie müssen natürlich nur noch die Befehle ausführen, die in den vorherigen Punkten nicht abgedeckt sind.
-  Führen Sie noch diesen Befehl **zusätzlich** aus, **bevor** Sie den Service neu starten
  `sudo sed -i 's/127.0.0.1/0.0.0.0/g' /etc/mysql/mariadb.conf.d/50-server.cnf`. Dieser Befehl ändert die Konfigurationsdatei der Datenbank und lässt externe Verbindungen zu. Lassen Sie sich die Konfigurationsdatei anzeigen und finden Sie den Key, welcher ersetzt wurde (z.B. mit Hilfe des grep-Befehls). Machen Sie einen Screenshot des Keys nachdem die Instanz erstellt wurde.

**2. Webserver**

- Führen Sie nicht einfach die Anweisungen als Befehle aus, sondern verwenden Sie die richtigen Konfigurationsblöcke. In Teil A) haben Sie einige davon ja bereits beschrieben.

- In KN03 hatten Sie Dateien via GIT geklont und dann an die Zielorte kopiert. Sie gehen nun ein wenig anders vor. Sie verwenden die **write_files**-Anweisung von Cloud-init, um Dateien zu erstellen. Sie finden in der Doku zu Cloud-init weitere Informationen. Sie können die Datei-Inhalte von Gitlab kopieren. 
- In KN03 hatten Sie verschiedene Befehle ausführen müssen. Verwenden Sie die **runcmd**-Anweisung von Cloud-init, um Befehle auszuführen. Sie müssen natürlich nur noch die Befehle ausführen, die in den vorherigen Punkten nicht abgedeckt sind.

- Fügen Sie das Paket *adminer* hinzu. Adminer bietet eine GUI, um Datenbanken zu administrieren. Sie müssen anschliessend die beiden folgenden Befehle ausführen (Die entsprechende Cloud-init-Anweisung kennen Sie bereits):
  1. `sudo a2enconf adminer`. Dies fügt die Konfiguration für das Paket *adminer* der *apache* Config hinzu
  2. Starten Sie den Apache Service neu.

**Abgaben DB Server**

1. Fügen Sie die Cloud-Init-Datei im Git-Repository hinzu.
1. Screenshot der Konfigurationsdatei des Datenbank-Services mit den veränderten Werten (z.B. mit dem Grep-Befehl nach den Werten suchen).

**Abgaben Webserver**

1. Rufen Sie die Seiten index.html, info.php und db.php auf und erstellen Sie einen Screenshot der URL und des Inhalts.
2. Rufen Sie Adminer auf  (http://ihre-ip/adminer/), verbinden Sie sich mit dem DB-Server und zeigen Sie mit Screenshots, dass die Verbindung funktioniert.
3. Fügen Sie die Cloud-Init-Datei im Git-Repository hinzu.



### Häufige Fehlerquellen

- Sie vergessen die erste Zeile in der Cloud-init Datei `#cloud-config`. Diese ist notwendig!
- Einrückungen wurden nicht korrekt erstellt. Das Format können Sie hier überprüfen: <https://www.yamllint.com/>.
- Sie können auf dem Server die Log-Datei für Fehler durchsuchen: `/var/log/cloud-init-output.log`
- Das Format des SSH-Schlüssels ist falsch. Korrekt ist: `ssh-key XXXXXXXXXX aws-key`.
- Falls Sie testen wollen, ob die Datenbank läuft, verwenden Sie folgende Befehle:
  - `mysql -u admin -p`: Sie loggen Sich auf die Datenbank ein. So sehen Sie, ob der Service läuft und Ihr Benutzer korrekt ist. Diesen Befehl führen Sie auf dem Server aus, auf dem die Datenbank installiert ist.
  - `telnet <IP> 3306`: Diesen Befehl führen Sie auf dem Server aus, von dem Sie sich auf die Datenbank verbinden möchten, z.B. der Webserver. Dieser Befehl zeigt Ihnen, ob die Datenbank auf dem Port antwortet. Falls nicht, haben Sie wahrscheinlich die Firewall nicht korrekt eingerichtet.




### Quellen

puttygen: [Puttygen download](https://www.puttygen.com/)

Thorntech: [Passwords vs. SSH keys - what's better for authentication?](https://thorntech.com/passwords-vs-ssh)



## Leitfragen / Checkpoints

- Ich kenne die YAML-Syntax und kann diese auch anwenden, speziell auch Listen und Verschachtelungen von Objekten
- Ich kenne die Grundstruktur von Cloud-Init Dateien und kann eine YAML Datei lesen
- Ich kenn die Cloud-Init Konfigurationsblöcke *users, ssh_pwauth, disable_root, package_update, packages, write_files, runcmd*, kann die Funktionsweise erklären und auch anwenden.
- Ich kenne den Speicherort der Cloud-Init Logs und kann diese bei Fehler und Probleme lesen und interpretieren.
